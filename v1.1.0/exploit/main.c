#include "../heap/heap.h"
#include <stdio.h>
#include <time.h>
#include <stdlib.h>
#include <string.h>

#define BUFFER_SIZE 512
#define COMMAND_SIZE 4096

struct user
{
	char* username;
	char* password;
	int id; /* -1 if user deleted, unique to each user*/
};
typedef struct user user;

struct user_list
{
	user* users;
	size_t len;
};
typedef struct user_list user_list;

user_list new_user_list()
{
	user_list ulist;

	ulist.users = NULL;
	ulist.len = 0;

	return ulist; 
}

/* username and password have to be halloc'd */
void ulist_new_user(user_list* ulist, char* username, char* password)
{
	if(ulist->len == 0)
	{
		ulist->users = halloc(sizeof(user));
	}
	else
	{
		ulist->users = hralloc(ulist->users, (ulist->len + 1)*sizeof(user));
	}
	ulist->users[ulist->len].username = username;
	ulist->users[ulist->len].password = password;
	ulist->users[ulist->len].id = ulist->len;
	ulist->len++;
}

void ulist_delete_user(user_list* ulist, int index)
{
	hfree(ulist->users[index].username);
	hfree(ulist->users[index].password);
	ulist->users[index].id = -1;
}

void ulist_destroy(user_list* ulist)
{
	for(size_t i = 0 ; i < ulist->len ; i++)
	{
		ulist_delete_user(ulist, i);
	}
}

void print_users(user_list* ulist, int id)
{
	printf("All users : \n");
	for(size_t i = 0 ; i < ulist->len ; i++)
	{
		if(ulist->users[i].id != -1)
		{
			
			printf("[%d] : '%s'", ulist->users[i].id, ulist->users[i].username);
			if(ulist->users[i].id == id)
			{
				printf(" <--- logged in as \n");
			}
			else
			{
				printf("\n");
			}
		}
		
	}
}

/* Copies from an address until a char, where it places a null byte */
size_t strccpy(char* dst, char* src, char end)
{
	size_t count;
	while(*src != end && *src != '\0')
	{
		*dst++ = *src++;
		count++;
	}
	*dst = '\0';
	return count;
}

int main(void)
{
	/* list of all users */
	user_list ulist = new_user_list();

	int action;
	char* username;
	char* password;

	int id_input;
	char username_input[BUFFER_SIZE];
	char password_input[BUFFER_SIZE];

	int id = -1;

	while(1)
	{
		printf("Enter action (enter 6 for help) : ");
		scanf("%d", &action);
		getc(stdin);

		/* create user */
		if(action == 1)
		{
			username = halloc(BUFFER_SIZE);
			password = halloc(BUFFER_SIZE);

			printf("Enter username for this new user : ");
			gets(username);

			printf("Enter password for this new user : ");
			gets(password);

			ulist_new_user(&ulist, username, password);
			printf("Created user\n");

			id = ulist.len - 1;
		}
		/* log in */
		else if(action == 2)
		{
			printf("Enter user id : ");
			scanf("%d", &id_input);
			getc(stdin);

			printf("Enter password for '%s' : ", ulist.users[id_input].username);
			gets(password_input);

			if(id_input >= 0 && id_input < ulist.len)
			{
				if(strcmp(password_input, ulist.users[id_input].password) == 0)
				{
					id = id_input;
					printf("Logged in as '%s'@%d\n", ulist.users[id].username, ulist.users[id].id);
				}
				else
				{
					fprintf(stderr, "Error : Wrong password\n");
				}
			}
			else
			{
				fprintf(stderr, "Error : User at id %d doesn't exist\n", id_input);
			}
		}
		/* delete user */
		else if(action == 3)
		{
			if(id >= 0)
			{
				ulist_delete_user(&ulist, id);
				printf("User deleted and disconnected\n");
				//printf("value : %lx\n", changeme);
				id = -1;
			}
			else
			{
				fprintf(stderr, "Error : Not logged in\n");
			}
		}
		/* print users */
		else if(action == 4)
		{
			if(id >= 0)
			{
				print_users(&ulist, id);
			}
			else
			{
				fprintf(stderr, "Error : Not logged in\n");
			}
			
		}
		/* disconnect*/
		else if(action == 5)
		{
			if(id >= 0)
			{
				id = -1;
			}
			else
			{
				fprintf(stderr, "Error : Not logged in\n");
			}
		}
		else if(action == 6)
		{
			printf("0 : Exit\n1 : Create new user\n2 : Log in as a user\n3 : Delete current user\n4 : Print all users\n5 : Disconnect\n6 : Print help\n");
		}
		else if(action == 0)
		{
			ulist_destroy(&ulist);
			exit(0);
		}
		else
		{
			
			fprintf(stderr, "Error : Command doesn't exist\n");
		}
	}
	
	/*
		create_user <username> <password>
		login_user <id> <password>
		delete_user <id>
		print_users
		
		exit
	*/

}